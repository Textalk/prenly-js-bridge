(function(i,r){typeof exports=="object"&&typeof module<"u"?module.exports=r():typeof define=="function"&&define.amd?define(r):(i=typeof globalThis<"u"?globalThis:i||self,i.PrenlyAppSDK=r())})(this,function(){"use strict";var v=Object.defineProperty;var m=(i,r,d)=>r in i?v(i,r,{enumerable:!0,configurable:!0,writable:!0,value:d}):i[r]=d;var o=(i,r,d)=>(m(i,typeof r!="symbol"?r+"":r,d),d);function i(){let n=()=>{},e=()=>{};return{promise:new Promise((t,a)=>{n=t,e=a}),resolve:n,reject:e}}class r{constructor({timeoutDuration:e=6e4,targetWindow:s,targetOrigin:t}){o(this,"requestCount",0);o(this,"pendingRequests",{});o(this,"eventListeners",{});o(this,"timeoutDuration");o(this,"targetWindow");o(this,"targetOrigin");o(this,"handleResponse",e=>{if(e.origin&&this.targetOrigin&&e.origin!==this.targetOrigin)return;let s;try{s=typeof e.data=="string"?JSON.parse(e.data):e.data}catch(h){console.error(h);return}const{requestId:t,type:a,data:u,error:g}=s;t&&this.pendingRequests[t]?this.processPendingRequest(t,u,g):a&&this.eventListeners[a]&&this.processEventListener(a,u)});this.timeoutDuration=e,this.targetWindow=s,this.targetOrigin=t,window.addEventListener("message",this.handleResponse)}processPendingRequest(e,s,t){t?this.pendingRequests[e].reject(t):this.pendingRequests[e].resolve(s)}processEventListener(e,s){this.eventListeners[e].forEach(t=>{t.callback(s,t.usePrevData?t.prevData:void 0),t.prevData=s})}generateRequestId(){return this.requestCount+=1,`${this.requestCount}-${Math.random().toString(36).substring(2,15)}`}async pendingRequestTimeoutAndCleanup(e,s,t,a=!0){let u;try{return await Promise.race([e,...a?[new Promise(()=>u=setTimeout(()=>s({code:"rejected",message:`Request timed out after ${this.timeoutDuration} milliseconds.`}),this.timeoutDuration))]:[]])}catch(g){console.error(g)}finally{u&&clearTimeout(u),delete this.pendingRequests[t]}}postMessageToTarget(e){var s,t;(t=(s=window.webkit)==null?void 0:s.messageHandlers)!=null&&t.iosListener?window.webkit.messageHandlers.iosListener.postMessage(e):window.AndroidInterface?window.AndroidInterface.postMessage(JSON.stringify(e)):this.targetWindow&&this.targetOrigin&&this.targetWindow.postMessage(e,this.targetOrigin)}async sendMessageAsync(e,s,t){const{useTimeout:a=!0}=t||{},{promise:u,resolve:g,reject:h}=i(),c=this.generateRequestId();this.pendingRequestTimeoutAndCleanup(u,h,c,a),this.pendingRequests[c]={resolve:g,reject:h};const f={type:e,data:s,requestId:c};return this.postMessageToTarget(f),u}on(e,s,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push({callback:s,prevData:void 0,usePrevData:t})}off(e,s){this.eventListeners[e]&&(s&&(this.eventListeners[e]=this.eventListeners[e].filter(t=>t.callback!==s)),(!s||!this.eventListeners[e].length)&&delete this.eventListeners[e])}destroy(){window.removeEventListener("message",this.handleResponse),this.pendingRequests={},this.eventListeners={}}}function d(n){return{version:"1.0",async login(){return n.sendMessageAsync("prenly_login",void 0,{useTimeout:!1})},async logout(){return n.sendMessageAsync("prenly_logout")},async getUserJwt(){return n.sendMessageAsync("prenly_get_user_jwt")},async getUserConsent(){return n.sendMessageAsync("prenly_get_user_consent")},on(e,s){const t=p(e);n.on(t.type,s,t.usePrevData)},off(e,s){n.off(p(e).type,s)}}}function p(n){switch(n){case"userConsentChange":return{type:"prenly_on_user_consent_change",usePrevData:!0};case"userLogin":return{type:"prenly_on_user_login",usePrevData:!1};case"userLogout":return{type:"prenly_on_user_logout",usePrevData:!1};default:throw new Error(`Unknown event type: ${n}.`)}}class l{constructor(e,s){o(this,"supportedVersion",window.PRENLY_APP_BRIDGE_SUPPORTED_VERSION);o(this,"api");o(this,"destroy");const t=new r({targetWindow:e,targetOrigin:s});this.setApi(t),this.destroy=this.makeDestroy(t)}setApi(e){switch(this.supportedVersion){case"1.0":this.api=d(e);break;default:throw new Error(`Unsupported version: ${this.supportedVersion}.`)}}makeDestroy(e){return()=>{this.api=void 0,e.destroy()}}}return l});
